version: "3.8"

services:
  api:
    build:
      context: ..
      dockerfile: Dockerfile.api
    container_name: neoflow-api
    env_file:
      - ../.env
    environment:
      HOST: 0.0.0.0
      PORT: 8080
      SUPABASE_URL: http://kong:8000
      # 与 supabase/.env 一致：用 ANON_KEY、SERVICE_ROLE_KEY，后端读 SUPABASE_* 即可
      SUPABASE_ANON_KEY: ${ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SERVICE_ROLE_KEY}
      UPLOAD_FOLDER: /app/uploads
      LOG_FILE: /app/logs/app.log
      OCR_DET_MODEL_PATH: /app/model/PP-OCRv5_server_det_infer
      OCR_REC_MODEL_PATH: /app/model/PP-OCRv5_server_rec_infer
      OCR_ORI_MODEL_PATH: /app/model/PP-LCNet_x1_0_textline_ori_infer
      OCR_DOC_MODEL_PATH: /app/model/PP-LCNet_x1_0_doc_ori_infer
      OCR_ENABLED: "true"
      OCR_IR_OPTIM: "false"
      OCR_USE_MKLDNN: "false"
      FLAGS_enable_ir_optim: "false"
      FLAGS_disable_ir_pass: "self_attention_fuse_pass"
    volumes:
      - ../uploads:/app/uploads
      - ../logs:/app/logs
      - ../model:/app/model
    depends_on:
      - kong
    expose:
      - "8080"
    restart: unless-stopped
    networks:
      - supabase-network

  web:
    build:
      context: ..
      dockerfile: web/Dockerfile
      args:
        VITE_API_URL: /api
        VITE_SUPABASE_URL: /supabase
    container_name: neoflow-web
    expose:
      - "80"
    restart: unless-stopped
    networks:
      - supabase-network

  ingress:
    image: nginx:1.25-alpine
    container_name: neoflow-ingress
    volumes:
      - ../deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - web
      - api
      - kong
    ports:
      - "${INGRESS_HTTP_PORT:-8080}:80"
    restart: unless-stopped
    networks:
      - supabase-network

networks:
  supabase-network:
    driver: bridge
