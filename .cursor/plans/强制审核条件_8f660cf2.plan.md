---
name: 强制审核条件
overview: 在审核保存接口引入“字段必须为指定值”的校验，并把规则存放在 `template_fields` 中，便于后续做业务配置平台。
todos:
  - id: db-fields
    content: 新增template_fields规则列并配置示例值
    status: pending
  - id: api-validate
    content: 审核保存接口增加强制值校验逻辑
    status: pending
  - id: tests
    content: 补充审核校验的单元测试/接口测试
    status: pending
isProject: false
---

# 强制审核条件方案

## 目标

- 审核保存时，如果字段值不在配置的允许值列表中，阻断审核并提示。
- 规则由模板字段配置驱动，后续可在配置平台维护。

## 方案选择（建议）

- 规则配置位置：`template_fields` 表。
- 增加列：
  - `review_enforced` (bool, 默认 false)
  - `review_allowed_values` (jsonb 数组，如 ["合格","不合格"])

## 实施步骤

1. **数据库结构调整**

   - 在 `template_fields` 表新增 `review_enforced`、`review_allowed_values` 字段（jsonb）。
   - 给检测报告“结论”字段配置允许值：`["合格","不合格"]`。

2. **审核接口校验**

   - 在 [`e:/zhuomian/GNEO_AI/sj_ocr/ocr_agentic_system/api/routes/documents/review.py`](e:/zhuomian/GNEO_AI/sj_ocr/ocr_agentic_system/api/routes/documents/review.py) 中，`validate_document` 更新数据前新增校验逻辑。
   - 校验步骤：
     - 读取文档信息获取 `template_id`、`tenant_id`。
     - 通过 `template_id` 或 `document_type + tenant_id` 取模板字段配置。
     - 对 `review_enforced=true` 且配置了 `review_allowed_values` 的字段做检查：若 `request.data[field_key] `不在允许值数组中，抛出 `ValidationError`，提示“字段 X 必须为 …”。

3. **错误提示格式**

   - 使用现有 `ValidationError`（HTTP 400），detail 里包含字段名与允许值，保证前端可直接展示“强制提醒”。

## 关键落点代码

- 审核入口：
```22:70:e:/zhuomian/GNEO_AI/sj_ocr/ocr_agentic_system/api/routes/documents/review.py
@router.put("/{document_id}/validate")
async def validate_document(...):
    # ... 当前逻辑
```

- 模板字段来源：`template_fields` 已在 `TemplateService.get_template_by_code/get_template_with_details` 返回。

## 需要你确认/准备

- 在 Supabase 中新增 `template_fields` 字段并配置业务字段规则（我会按上述字段名实现）。
- 如需不同字段名或更复杂表达式（比如正则、区间），需再扩展规则结构。