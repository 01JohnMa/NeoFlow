---
name: 统一分类为检测报告
overview: 将所有"测试单"和"检验报告"统一改为"检测报告"，包括后端服务、前端页面和数据库模板名称，不保留历史别名。
todos:
  - id: update-prompts
    content: 修改 config/prompts.py 中的分类结果为检测报告
    status: completed
  - id: update-workflow
    content: 修改 agents/workflow.py 中 _fallback_classify 返回检测报告
    status: completed
  - id: update-supabase-service
    content: 修改 services/supabase_service.py 的 TABLE_MAP 和 generate_display_name
    status: completed
  - id: update-template-service
    content: 修改 services/template_service.py 的 DOC_TYPE_TO_CODE
    status: completed
  - id: update-review
    content: 修改 api/routes/documents/review.py 中的类型判断
    status: completed
  - id: update-query
    content: 修改 api/routes/documents/query.py 中的类型映射
    status: completed
  - id: update-upload-tsx
    content: 修改 web/src/pages/Upload.tsx 提示文字
    status: completed
  - id: update-document-detail-tsx
    content: 修改 web/src/pages/DocumentDetail.tsx 类型判断
    status: completed
  - id: update-documents-tsx
    content: 修改 web/src/pages/Documents.tsx 下拉选项
    status: completed
  - id: create-migration
    content: 创建数据库迁移脚本 012_unify_inspection_report.sql
    status: completed
---

# 统一分类结果：测试单/检验报告 -> 检测报告

## 修改目标

将所有"测试单"和"检验报告"统一改为"检测报告"，包括分类结果、数据库模板名称和前端显示，不保留历史别名。

## 后端修改

### 1. [config/prompts.py](config/prompts.py) - 分类 Prompt

- 第 10 行：`2. 测试单：...` -> `2. 检测报告：...`
- 第 17 行：`"测试单"` -> `"检测报告"`
- 第 21 行注释：`# 检验报告/测试单提取Prompt` -> `# 检测报告提取Prompt`

### 2. [agents/workflow.py](agents/workflow.py) - 回退分类

- 第 194 行：`return "测试单"` -> `return "检测报告"`

### 3. [services/supabase_service.py](services/supabase_service.py) - 表映射

简化 `TABLE_MAP`（第24-26行）：

- 移除 `"测试单"`, `"检验报告"` 别名
- 只保留 `"检测报告": "inspection_reports"`

简化 `generate_display_name`（第588、632-634行）：

- 移除历史别名判断

### 4. [services/template_service.py](services/template_service.py) - 简化映射

简化 `DOC_TYPE_TO_CODE`（第102-104行）：

- 只保留 `"检测报告": "inspection_report"`

### 5. [api/routes/documents/review.py](api/routes/documents/review.py) - 审核逻辑

- 第 32 行注释
- 第 73 行：`"测试单"` -> `"检测报告"`

### 6. [api/routes/documents/query.py](api/routes/documents/query.py) - 查询逻辑

- 第 109 行：`"测试单"` -> `"检测报告"`

## 前端修改

### 7. [web/src/pages/Upload.tsx](web/src/pages/Upload.tsx)

- 第 672 行：`快递单/测试单/抽样单` -> `快递单/检测报告/抽样单`

### 8. [web/src/pages/DocumentDetail.tsx](web/src/pages/DocumentDetail.tsx)

- 第 77 行：`type === '测试单'` -> `type === '检测报告'`
- 第 390 行注释：`测试单` -> `检测报告`
- 第 393 行：`documentType === '测试单'` -> `documentType === '检测报告'`

### 9. [web/src/pages/Documents.tsx](web/src/pages/Documents.tsx)

- 第 117 行：`<option value="测试单">检验报告</option>` -> `<option value="检测报告">检测报告</option>`

## 数据库迁移

### 10. 创建迁移脚本 `supabase/migrations/012_unify_inspection_report.sql`

```sql
-- 将模板名称从"检验报告"改为"检测报告"
UPDATE document_templates SET name = '检测报告' WHERE code = 'inspection_report';

-- 将历史文档类型统一为"检测报告"
UPDATE documents SET document_type = '检测报告' 
WHERE document_type IN ('测试单', '检验报告') AND document_type != '检测报告';
```

## 最终映射关系

- 分类结果: 检测报告
- 模板 code: inspection_report
- 模板 name: 检测报告
- 数据库表: inspection_reports