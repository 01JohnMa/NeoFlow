---
name: 修复模板ID查询
overview: 修复 process-merge API，让它支持按模板 code 查询，而不仅仅是 UUID。这样前端可以使用固定的 `lighting_combined` code。
todos:
  - id: fix-template-query
    content: 修改 process_merge API，支持按 code 查询模板
    status: completed
---

# 修复模板 ID 查询问题

## 问题

前端传递 `template_id = 'lighting_combined'`（模板 code），但后端 `get_template()` 期望 UUID 格式：

```
invalid input syntax for type uuid: "lighting_combined"
```

## 修复方案

修改 [api/routes/documents/process.py](api/routes/documents/process.py) 中的 `process_merge` 函数：

将第 419 行的 `get_template()` 改为 `get_template_by_code()`，同时支持 UUID 和 code 查询。

### 修改前

```python
# 获取模板
template = await template_service.get_template(request.template_id)
```

### 修改后

```python
# 获取模板（支持 UUID 或 code）
# 先尝试按 code 查询，如果是 UUID 格式则按 ID 查询
template = await template_service.get_template_by_code(user.tenant_id, request.template_id)
if not template:
    # 如果按 code 没找到，尝试按 UUID 查询（向后兼容）
    template = await template_service.get_template(request.template_id)
```

## 文件修改

- [api/routes/documents/process.py](api/routes/documents/process.py) 第 418-421 行