---
name: 照明多样品OCR支持
overview: 改造照明 OCR 流程，支持积分球 PDF 多页逐页提取，每个样品的积分球数据与同一份光分布数据合并，输出多条记录。
todos:
  - id: ocr-per-page
    content: OCR 服务新增 process_document_per_page 逐页处理方法
    status: completed
  - id: workflow-merge
    content: 改造 process_merge 支持积分球逐页提取与多样品合并
    status: completed
  - id: api-adapt
    content: 适配 API 层返回多条结果（如需要）
    status: pending
isProject: false
---

# 照明多样品 OCR 支持方案

## 需求理解

- 积分球 PDF 可能有 1-2 页，每页代表一个样品
- 光分布 PDF 只有 1 个样品
- 最终输出：每个积分球样品 + 同一份光分布数据 = 一条记录
- 如果 2 个样品，生成 2 条记录
- **低耦合要求**：这是照明独有逻辑，不影响其他租户/模板的处理流程

## 当前问题

1. [services/ocr_service.py](services/ocr_service.py) 的 `_process_sync` 把所有页合并成一个文本
2. [agents/workflow.py](agents/workflow.py) 的 `process_merge` 对积分球只做一次 LLM 提取

## 低耦合改造方案

### 1. 配置驱动：通过合并规则控制行为

在 `template_merge_rules` 表新增字段 `per_page_extraction`（布尔），标记是否需要逐页提取。

- 只有照明积分球设置为 `true`
- 其他模板保持默认 `false`，走原有逻辑
```sql
-- 004_lighting_per_page.sql
ALTER TABLE template_merge_rules ADD COLUMN per_page_extraction BOOLEAN DEFAULT FALSE;

UPDATE template_merge_rules 
SET per_page_extraction = TRUE 
WHERE template_id = 'b0000000-0000-0000-0000-000000000012';  -- 照明综合报告
```


### 2. OCR 层面：新增独立的逐页方法（不修改原有方法）

在 `services/ocr_service.py` 新增**独立方法**：

```python
async def process_document_per_page(self, file_path: str) -> List[Dict[str, Any]]:
    """逐页处理文档，返回每页独立的 OCR 结果
    
    仅供需要逐页提取的场景使用（如照明积分球多样品）
    """
    # 返回 [{"text": "页1文本", "page": 1, "confidence": 0.95}, ...]
```

- **不修改** `process_document` 原有行为
- 新方法独立存在，按需调用

### 3. workflow 层面：在 process_merge 中添加配置分支

在 `process_merge` 方法中根据 `per_page_extraction` 配置决定处理方式：

```python
async def process_merge(self, ...):
    merge_rule = await template_service.get_merge_rule(template_id)
    
    # 照明特有：检查是否需要逐页提取
    per_page_extraction = merge_rule.get("per_page_extraction", False)
    
    for file_info in files:
        doc_type = file_info.get("doc_type")
        
        if per_page_extraction and doc_type == merge_rule.get("doc_type_a"):
            # 照明积分球：逐页处理
            page_results = await ocr_service.process_document_per_page(file_path)
            results_a = []
            for page in page_results:
                prompt = template_service.build_extraction_prompt(sub_template_a, page["text"])
                result = await self._llm_invoke_with_retry(prompt)
                results_a.append(json.loads(result))
        else:
            # 其他场景：保持原有逻辑
            ocr_result = await ocr_service.process_document(file_path)
            ...
    
    # 合并：光分布数据 × 每个积分球样品
    merged_results = []
    for i, result_a in enumerate(results_a):
        merged = template_service.merge_extraction_results(result_a, result_b)
        merged_results.append({"sample_index": i + 1, "data": merged})
    
    return {"extraction_results": merged_results, ...}
```

### 4. 返回结构调整

```python
{
    "success": True,
    "extraction_results": [   # 数组，兼容单样品和多样品
        {"sample_index": 1, "data": {光分布 + 积分球样品1}},
        {"sample_index": 2, "data": {光分布 + 积分球样品2}}  # 可选
    ],
    ...
}
```

## 低耦合设计要点

| 层面 | 设计 | 影响范围 |

|------|------|----------|

| 配置 | `per_page_extraction` 字段控制 | 仅照明模板开启 |

| OCR | 新增独立方法，不改原有 | 零影响 |

| workflow | 配置分支，默认走原逻辑 | 其他租户无感知 |

| 返回结构 | 数组兼容单/多样品 | 向后兼容 |

## 涉及文件

- [supabase/migrations/](supabase/migrations/) - 新增 `per_page_extraction` 字段
- [services/ocr_service.py](services/ocr_service.py) - 新增 `process_document_per_page` 方法
- [agents/workflow.py](agents/workflow.py) - `process_merge` 添加配置分支
- API 层（如需要）- 适配返回多条结果

## 兼容性

- **质量运营部**：无任何影响，`per_page_extraction` 默认 `false`
- **照明单样品**：返回数组长度为 1，兼容现有逻辑
- **照明多样品**：返回数组长度 > 1，上游按需处理